name: Build Pre-release

on:
  push:
    branches:
      - master

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PESDE_VERSION: '0.6.2+registry.0.2.2'
      ASSET_NAME: pesde-0.6.2-linux-x86_64.zip

    steps:
      - name: Setup Pesde
        uses: ernisto/setup-pesde@v0.4.2-dev.1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
 
      - name: Prebuild
        run: |
          set -euo pipefail
          export PATH="$PATH:$HOME/.pesde/bin"
          pesde install
          mkdir -p src/network
          blink main || { echo "Error: Prebuild failed"; exit 1; }

      - name: Build
        run: |
          set -euo pipefail
          export PATH="$PATH:$HOME/.pesde/bin"
          rojo build --output rcs.rbxlx || { echo "Error: Build failed"; exit 1; }

      - name: Create Release and Upload Artifact
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-${{ github.sha }}
          name: Auto Build ${{ github.sha }}
          body: Automated build for commit ${{ github.sha }}
          prerelease: true
          files: rcs.rbxlx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          rm -rf pesde.zip pesde-bin rcs.rbxlx
